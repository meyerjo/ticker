{% extends 'user/manage_base.html' %}

{% load custom_tags %}
{% load staticfiles %}
{% block extracss %}
    <link href="{% static 'css/ticker_interface.css' %}" rel="stylesheet"/>
{% endblock %}

{% block extrajs %}
    <script type="text/javascript" src="{% static 'js/django_csrf_post.js' %}"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            $('form[name^="field_"]').find(':button').on('click', function () {
                event.preventDefault();
                var calling_button = this.name;
                var calling_value = this.value;
                var action = $(this).closest('form').attr('action');
                var csrftoken = $(this).closest('form').find('input[name="csrfmiddlewaretoken"]').val();

                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                            // Send the token to same-origin, relative URLs only.
                            // Send the token only if the method warrants CSRF protection
                            // Using the CSRFToken value acquired earlier
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });
                var obj = {};
                obj[calling_button] = calling_value;
                $.ajax({
                    url: action + '/json',
                    method: 'post',
                    data: obj
                }).done(function(data) {
                    var result_obj = $.parseJSON(data);
                    if (result_obj['type'] == 'score-update') {
                        var field_id = result_obj['field_id'];
                        var set_id = result_obj['set_id'];
                        var game_id = result_obj['game_id'];
                        var set_score = result_obj['set_score'];
                        var set_number = result_obj['set_number'];

                        $('#field_' + field_id + '_current_set_team_a').html(set_score[0]);
                        $('#field_' + field_id + '_current_set_label').html('Satz ' + set_number);
                        $('#field_' + field_id + '_current_set_team_b').html(set_score[1]);
                        $('#field_' + field_id +'_set_' + set_number +'_team_a').html(set_score[0]);
                        $('#field_' + field_id +'_set_' + set_number +'_team_b').html(set_score[1]);
                        $('#score_game_' + game_id).html(result_obj['game_score']);
                        if (result_obj['set_finished']) {
                            $('#field_' + field_id + '_next_set').removeClass('hidden');
                        } else {
                            $('#field_' + field_id + '_next_set').addClass('hidden');
                        }
                    } else if (result_obj['type'] == 'clear-field') {
                        var field_id = result_obj['field_id'];
                        var game_name = result_obj['game_name'];
                        var game_id = result_obj['game_id'];

                        var selector_form = 'form[name="field_' + field_id + '"]';
                        $(selector_form).find('div.player').html('');
                        $(selector_form).find('div.setscore').html('');
                        $('#field' + field_id + '_current_set_label').html('');
                        $('#field_' + field_id + '_next_set').addClass('hidden');

                        // change the link and style of the field in the name
                        // TODO: reset the link properly
                        $('#row_' + game_id).find('a.fieldname.active').attr('href', '#TODO');
                        $('#row_' + game_id).find('.fieldname').removeClass('active');
                    } else if (result_obj['type'] == 'update-current-set') {
                        var field_id = result_obj['field_id'];
                        var selector_form = 'form[name="field_' + field_id + '"]';
                        var set_score = result_obj['set_score'];
                        var set_number = result_obj['set_number'];

                        $('#field_' + field_id + '_current_set_team_a').html(set_score[0]);
                        $('#field_' + field_id + '_current_set_team_b').html(set_score[1]);
                        $('#field_' + field_id + '_current_set_label').html('Satz ' + set_number);
                        $('#field_' + field_id + '_next_set').addClass('hidden');
                    } else {
                        console.log('Unknown content type: ' +  data)
                    }
                })
            })
        })
    </script>
{% endblock %}


{% block content %}
    <div class="container">
        {% if messages %}
            <div class="row-fluid">
                <div class="col-sm-12">
                    <ul class="messages">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        {% endif %}
        <div class="row-fluid headline">
            {% with score=match.get_score team_names=match.get_team_names %}
                <div class="col-sm-4 teamname">{{ team_names.0 }} <a href="{% url 'manage_teams_details' match.team_a.id %}">(<i class="fa fa-link"></i>)</a></div>
                <div class="col-sm-4 score">{{ score.0 }} - {{ score.1 }}</div>
                <div class="col-sm-4 teamname">{{ team_names.1 }} <a href="{% url 'manage_teams_details' match.team_b.id %}">(<i class="fa fa-link"></i>)</a></div>
            {% endwith %}
        </div>
        <div class="row-fluid fields">
            {% with fields=match.get_fields %}
                {% with fieldamount=fields|length %}
                    {% for field in fields %}
                        <form method="post" action="{% url 'update_score_field' field.id '' %}" name="field_{{ field.id }}">
                            {% csrf_token %}
                            <div class="col-sm-{{ 12|get_field_width:fieldamount }}">
                                <div class="row-fluid">
                                    <div class="col-sm-12 fieldtitle">{{ field.field_name }}</div>
                                    {% if field.get_game %}
                                        {% with game=field.get_game %}
                                            <div class="col-sm-6 player">
                                                {{ game.player_a|format_players|safe }}
                                            </div>
                                            <div class="col-sm-6 player">
                                                {{ game.player_b|format_players|safe }}
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-4">
                                                    <button type="submit" class="btn btn-primary" name="team_a" value="+">+</button>
                                                    <button type="submit" class="btn btn-primary" name="team_a" value="-">-</button>
                                                </div>
                                                <div class="col-sm-1 setscore" id="field_{{ field.id }}_current_set_team_a">
                                                    {{ game.get_current_set.get_score.0 }}
                                                </div>
                                                <div class="col-sm-2" id="field_{{ field.id }}_current_set_label">
                                                    Satz {{ game.get_current_set.set_number }}
                                                </div>
                                                <div class="col-sm-1 setscore" id="field_{{ field.id }}_current_set_team_b">
                                                    {{ game.get_current_set.get_score.1 }}
                                                </div>
                                                <div class="col-sm-4">
                                                    <button type="submit" class="btn btn-primary" name="team_b" value="+">+</button>
                                                    <button type="submit" class="btn btn-primary" name="team_b" value="-">-</button>
                                                </div>
                                            </div>
                                            <div
                                            {% if game.get_current_set|finished_set:match %}
                                                class="row"
                                            {% else %}
                                                class="row hidden"
                                            {% endif %}
                                            id="field_{{ field.id }}_next_set">
                                            <div class="col-sm-12" style="text-align: center">
                                                <button type="submit" class="btn btn-primary" name="switch_set" value="True">
                                                    Naechster Satz
                                                </button>
                                            </div>
                                            </div>
                                            {% for set in game.get_set_objects %}
                                                <div class="row set {{ set|is_current_set:game }}">
                                                    {% with score=set.get_score %}
                                                        <div class="col-sm-5 setscore" id="field_{{ field.id }}_set_{{ forloop.counter }}_team_a">{{ score.0 }}</div>
                                                        <div class="col-sm-2">Satz {{ set.set_number }}</div>
                                                        <div class="col-sm-5 setscore" id="field_{{ field.id }}_set_{{ forloop.counter }}_team_b">{{ score.1 }}</div>
                                                    {% endwith %}
                                                </div>
                                            {% endfor %}
                                        {% endwith %}
                                    {% endif %}
                            </div>
                        </div>
                        </form>
                    {% endfor %}
                {% endwith %}
            {% endwith %}
    </div>
    <div class="row-fluid matches">
        <div class="col-sm-12">
            <form method="post" action="{% url 'match_lineup_save' match.id '/' %}">
                {% csrf_token %}
                <table class="table table-responsive table-striped">
                    <tr>
                        <th>ID</th>
                        <th>Gamename</th>
                        <th>Spieler (Heim)</th>
                        <th>Spieler (Gast)</th>
                        <th>Saetze</th>
                        <th>Feld</th>
                        <th>Editieren</th>
                    </tr>
                    {% for game in match.get_all_games %}
                        <tr id="row_{{ game.id }}">
                            <td>{{ game.id }} <input type="hidden" name="game_id" value="{{ game.id }}"/> </td>
                            <td>{{ game.name }}</td>
                            <td>
                                <select name="player_a_one_{{ game.id }}">
                                    {% for player in game|get_players:"1,a" %}
                                        <option value="{{ player.0 }}" {{ player.2|is_selected }}>{{ player.1 }}</option>
                                    {% endfor %}
                                </select>
                                {% if game.game_type|is_in:"single" == 0 %}
                                    <select name="player_a_two_{{ game.id }}">
                                        {% for player in game|get_players:"2,a" %}
                                            <option value="{{ player.0 }}" {{ player.2|is_selected }}>{{ player.1 }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </td>
                            <td>
                                {% load custom_tags %}
                                <select name="player_b_one_{{ game.id }}">
                                    {% for player in game|get_players:"1,b" %}
                                        <option value="{{ player.0 }}" {{ player.2|is_selected }}>{{ player.1 }}</option>
                                    {% endfor %}
                                </select>
                                {% if game.game_type|is_in:"single" == 0 %}
                                    <select name="player_b_two_{{ game.id }}">
                                        {% for player in game|get_players:"2,b" %}
                                            <option value="{{ player.0 }}" {{ player.2|is_selected }}>{{ player.1 }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </td>
                            <td id="score_game_{{ game.id }}">{{ game.get_sets }}</td>
                            <td>
                                {% for field in match.get_fields %}
                                    {% with field_active=field|field_active:game %}
                                        {% if field_active == 'active' %}
                                            <a href="{% url 'remove_game_to_field' game.id field.id '' %}"
                                               class="fieldname {{ field_active }}">{{ forloop.counter }}</a>
                                        {% else %}
                                            <a href="{% url 'assign_game_to_field' game.id field.id '' %}"
                                               class="fieldname {{ field_active }}">{{ forloop.counter }}</a>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </td>
                            <td>
                                <a href="#EDIT">Edit</a>
                            </td>
                        </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="2"></td>
                        <td colspan="2">
                            <button class="btn btn-success lineup" value="lineup">Speichern</button>
                        </td>
                        <td colspan="2"></td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    </div>
{% endblock %}